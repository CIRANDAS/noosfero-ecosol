product-page
  .head
    h1.title
      |{t("views.product.products")}

    .filter
      input type='hidden' value="{page}"

      h4
        |{t("views.product.filter")}
      form.form-inline
        .form-group
          .name
            input type="text" name="filter_name" placeholder="{t('views.product.product_name')}" onclick="{search}"

        .form-group.category
          select name="category_id"
            option each="{id,name in categories}" value="{id}" selected="{name == filter_category}"
              |{name}

        .form-group.supplier
          select name="supplier_id"
            option each="{id,name in suppliers}" value="{id}" selected="{id == filter_supplier}"
              |{name}

        .form-group.state
          select name='available' onclick="{search}"
            option value="" selected="{filter_state == ''}"
              |{t('views.product.situation')}
            option value="true" selected="{filter_state == 'true'}"
              |{t('views.product.active')}
            option value="false" selected="{filter_state == 'false'}"
              |{t('views.product.inactive')}

  .mass_actions
    strong
      |{t('views.product.mass_action')}
    select name='action' id='mass_action_select'
      option value="activate"
        |{t('views.product.activate')}
      option value="deactivate"
        |{t('views.product.deactivate')}
    button name='ok' onclick="{massAction}"
      |{t('views.product.ok')}


  .clear
  .products-listing.table-responsive
    .table
      .header
        .image
          |{t('views.product.image')}
        .state
          |{t('views.product.state')}
        .name
          |{t('views.product.name')}
        .supplier
          |{t('views.product.supplier')}
        .category
          |{t('views.product.category')}
        .margin
          |{t('views.product.margin')}
        .stock
          |{t('views.product.stock')}
        .total_price
          |{t('views.product.total_price')}
        .supplier_price
          |{t('views.product.supplier_price')}
        .unit
          |{t('views.product.unit')}

      product-item each="{product in products}" product="{product}" class="{product.available ? 'available':'disabled'}"

  javascript:
    this.t = window.products.t
    this.products = opts.products
    this.categories = opts.categories
    this.suppliers = opts.suppliers
    this.units = opts.units
    this.page = opts.page
    this.filter_category = opts.filter_category
    this.filter_supplier = opts.filter_supplier
    this.filter_state = opts.filter_state

    massAction(e) {
     if (this.mass_action_select.value == 'activate') {
      this.changeState('activate')
     }
     else if (this.mass_action_select.value == 'deactivate') {
      this.changeState('deactivate')
     }
    }

    changeState(state) {
      var checked = $('.product-select:checked')
      if (checked) {
        var products = []
        checked.parents('product-item').each(function(i, product) {
          var func = product._tag[state]
          if (!func) return
          func();
          console.log(func)
          products.push(product._tag.product.id)
        })
        console.log(products);
      }
    }

    search() {
      var data = {
        state: this.filter_state,
        supplier: this.filter_supplier,
        category: this.filter_category,
        name: filter_name
      }

      var searchUrl = Routes.suppliers_plugin_product_path({profile: noosfero.profile, action: 'search'});
      $.post(searchUrl, data, function(response) {
        if (response) {
          console.log(response);
        }
      });
    }
