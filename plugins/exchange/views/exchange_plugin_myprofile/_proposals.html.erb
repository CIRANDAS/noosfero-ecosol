<% first = true %>
<% @proposals.each do |proposal| %>
    <% if !(proposal.state == "open" && proposal.enterprise_origin != profile) %>
      
    <% if proposal.state != "open" %>
      <p class="exc-plg-proposal_sent"><%= _('Proposal sent ') + proposal.date_sent.strftime("%d/%m/%Y @ %H:%Mh") %></p>
    <% end %>
    <div id="exc-plg-proposal_wrapper">
      <div id="exc-plg-proposal_header">
        <%= render :partial => "proposal_header", :locals => {:proposal => proposal}%>
      </div>
      <% if first && (@exchange.state == "proposal" || @exchange.state == "negociation")%>
        <%= render :partial => "proposal_buttons", :locals => {:proposal => proposal}%>
      <% end %>
    <div id="exc-plg-proposal_messages">
      <% if first && (@exchange.state == "proposal" || @exchange.state == "negociation")%>
        <div id='leave_scrap' style="float:none; height:70px;">
            <% form_remote_tag :url => {:action => 'new_message', :proposal_id => proposal.id} do  %>
              <%= text_area_tag 'body',nil, :rows => 2, :cols => 30, :placeholder => _('Digite sua mensagem') %>
              <%= submit_tag 'Enviar mensagem' %>
            <% end %>
        </div>
        <% first = false %>    
      <% end %>

      <div id="exc-plg-messages">
        <% if !proposal.messages.blank? %>
          <% proposal.messages.each do |m| %> 
            <%= render :partial => "message", :locals => {:message => m} %>          
          <% end %>
        <% end %>
      </div>
    </div>
    <div id="exc-plg-proposal_offer_request_wrapper">
      <div id="exc-plg-proposal_offer">
        <h3><%= _('You offer') %></h3>
        <ul id="exc-plg-profile_elements_list">
          <% @elements_profile = proposal.exchange_elements.select{|k| k.enterprise_id == profile.id} %>
          <% if !@elements_profile.blank? %>
            <% @elements_profile.each do |e| %>                            
              <%= render :partial => "element", :locals => {:element => e, :proposal => proposal, :enterprise => "profile"} %>              
            <% end %>
          <% end %>
        </ul>

        <% if proposal.state == "open" %>

          <h3><%= _('What you can offer?') %></h3>
          <div id="exc-plg-button-wrapper">
            <button class="exc-plg-exchange_plugin_button"><%= _('Add not registered product')%></button>
            <button class="exc-plg-exchange_plugin_button"><%= _('Add amount in money')%></button>
          </div>

          <% if @profile_products.blank? && @profile_knowledges.blank? %>
            <%= _("%s has no offers registered.") % profile.name %>
            <ul id="exc-plg-Product_profile_list" class="exc-plg-profile_offers">
            </ul> <!-- necessary to receive removed items -->
            <ul id="exc-plg-CmsLearningPluginLearning_profile_list" class="exc-plg-profile_offers">
            </ul> <!-- necessary to receive removed items -->
          <% else %>
            <ul id="exc-plg-Product_profile_list" class="exc-plg-profile_offers">
            <% if !@profile_products.blank? %>
              <h4><%= _('Your Products') %></h4>
              <% @profile_products.each do |p| %>
                <li id=exchange_Product_<%= p.id %>>
                    <%= link_to(p.category_name) + " " + link_to(p.name) %>
                    
                    <%= link_to_remote "<button class='exc-plg-exchange_plugin_button exc-plg-add'>+</button>", 
                    :url => {:action => "add_element", :element_id => p.id,  
                    :element_type => "Product", :enterprise => "profile", :exchange_id => @exchange.id,
                    :proposal_id => proposal.id} %>

                </li>
              <% end %>
              </ul>
            <% end %>
            <% if !@profile_knowledges.blank? %>
              <h4><%= _('Your Knowledges') %></h4>
              <ul id="exc-plg-CmsLearningPluginLearning_profile_list" class="exc-plg-profile_offers">
              <% @profile_knowledges.each do |k| %>
                <li id="exchange_CmsLearningPluginLearning_<%= k.id %>">
                    <%= link_to(k.name) %>

                    <%= link_to_remote "<button class='exc-plg-exchange_plugin_button exc-plg-add'>+</button>", 
                    :url => {:action => "add_element", :element_id => k.id,  
                    :enterprise_id => profile.id, :element_type => "CmsLearningPluginLearning", :exchange_id => @exchange.id, :proposal_id => proposal.id, :enterprise => "profile"} %>
                </li>
              <% end %>
              </ul>
            <% end %>
          <% end %>
      <% end %> <!-- if proposal.state == "open" -->

      </div>
      <div id="exc-plg-proposal_request">
        <h3><%= _('You ask') %></h3>
        <ul id="exc-plg-theother_elements_list">
          <% @elements_theother = proposal.exchange_elements.select{|k| k.enterprise_id == @theother.id} %>
          <% if !@elements_theother.blank? %>
            <% @elements_theother.each do |e| %>              
              <%= render :partial => "element", :locals => {:element => e, :proposal => proposal, :enterprise => "theother"} %> 
            <% end %>
          <% end %>          
        </ul>
        
      <% if proposal.state == "open" %>

        <h3><%= _('What do the other can offer?') %></h3>
        <div id="exc-plg-button-wrapper">
          <button class="exc-plg-exchange_plugin_button"><%= _('Add not registered product')%></button>
          <button class="exc-plg-exchange_plugin_button"><%= _('Add amount in money')%></button>
        </div>

        <% if @theother_products.blank? && @theother_knowledges.blank? %>
          <%= _("%s has no offers registered.") % profile.name %>
          <ul id="exc-plg-Product_theother_list" class="exc-plg-theother_offers">
          </ul> <!-- necessary to receive removed items -->
          <ul id="exc-plg-CmsLearningPluginLearning_theother_list" class="exc-plg-theother_offers">
          </ul> <!-- necessary to receive removed items -->
        <% else %>
          <% if !@theother_products.blank? %>
            <h4><%= _('Products') %></h4>
            <ul id="exc-plg-Product_theother_list" class="exc-plg-theother_offers">
            <% @theother_products.each do |p| %>
              <li id=exchange_Product_<%= p.id %>>

                  <%= link_to(p.category_name) + " " + link_to(p.name) %>
                  
                  <%= link_to_remote "<button class='exc-plg-exchange_plugin_button exc-plg-add'>+</button>", 
                  :url => {:action => "add_element", :element_id => p.id,  
                  :element_type => "Product", :enterprise => "theother", :exchange_id => @exchange.id,
                  :proposal_id => proposal.id} %>

              </li>
            <% end %>
            </ul>
          <% end %>
          <% if !@theother_knowledges.blank? %>
            <h4><%= _('Knowledges') %></h4>
            <ul id="exc-plg-CmsLearningPluginLearning_theother_list" class="exc-plg-theother_offers">
            <% @theother_knowledges.each do |k| %>
              <li id=exchange_CmsLearningPluginLearning_<%= k.id %>>

                  <%= link_to(k.name) %>

                  <%= link_to_remote "<button class='exc-plg-exchange_plugin_button exc-plg-add'>+</button>", 
                  :url => {:action => "add_element", :element_id => k.id,  
                  :enterprise_id => @theother.id, :element_type => "CmsLearningPluginLearning", :exchange_id => @exchange.id, :proposal_id => proposal.id, :enterprise => "theother"} %>

              </li>
            <% end %>
            </ul>
          <% end %>
        <% end %>
      <% end %> <!-- if proposal.state == "open" -->
      </div>
    </div> <!-- proposal_offer_request_wrapper -->
  </div> <!-- proposal_wrapper -->
  <% end %> <!-- if open and not profile -->
  <% end %> <!-- proposal.each -->