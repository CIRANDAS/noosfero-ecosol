<div id="sniffer-search-wrap">

  <div id="map-wrap">
    <div id="map"></div>

    <div id="map-overlay-wrap-1">
      <div id="map-overlay-wrap-2">
        <div id="map-overlay">
          <h1> <%= _('Opportunities Sniffer') %> </h1>

          <%= render :partial => 'product_search_box' %>
        </div>
      </div>
    </div>
  </div>

  <div id="legend-wrap-1">
    <div id="legend-wrap-2">
      <div id="legend">
        <span class="reading"> <b> <%= _('Reading') %> </b> </span>
        <img class="home" src="/plugins/sniffer/images/marker_home.png"/> <span><%= _("your enterprise") %></span>
        <img class="suppliers" src="/plugins/sniffer/images/marker_suppliers.png"/> <span><%= _("suppliers") %></span>
        <img class="consumers" src="/plugins/sniffer/images/marker_consumers.png"/> <span><%= _("consumers") %></span>
        <img class="both" src="/plugins/sniffer/images/marker_both.png"/> <span><%= _("both") %></span>
      </div>
    </div>
  </div>
</div>

<%= content_tag 'script', '', :src => "http://maps.googleapis.com/maps/api/js?sensor=false", :type => 'text/javascript' %>
<%= javascript_include_tag 'google_maps' %>

<% json_opts = {:only => [:id, :name, :lat, :lng], :methods => [:distance]} %>
<% map_data = @profiles.map do |profile, data|
  #next unless profile.lat and profile.lng

  profile_hash = {}
  (json_opts[:only]+json_opts[:methods]).each{ |m| profile_hash[m] = profile.send m }

  {:profile => profile_hash, :data => data}
end %>

<script type='text/javascript'>
  sniffer.map.load({
      zoom: <%= GoogleMaps.initial_zoom.to_json %>,
      balloonUrl: '<%= url_for(:controller => :sniffer_plugin_myprofile, :action => :map_balloon, :id => "_id_", :escape => false) %>',
      myBalloonUrl: '<%= url_for(:controller => :sniffer_plugin_myprofile, :action => :map_balloon, :escape => false) %>',
      profile: <%= profile.to_json json_opts %>,
      mapData: <%= map_data.to_json %>,
  });
</script>
